<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kwa Ntau ‚Äî Interactive Demo (Enhanced)</title>

<!-- Tailwind (quick demo styling) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --primary-600:#F28F22; --primary-500:#F3A744; --primary-300:#F8C883;
    --steel-700:#525C66; --eco-700:#2F7D47;
    --bg:#f5f7fa;
  }
  body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); }
  .kt-icon { width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--primary-500),var(--primary-300)); display:flex;align-items:center;justify-content:center;color:white;font-weight:700; box-shadow:0 6px 20px rgba(34,34,34,0.12); }
  .shadow-soft { box-shadow: 0 8px 30px rgba(16,24,40,0.06); }
  .pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0%{ transform:scale(1);} 50%{ transform:scale(1.03);} 100%{ transform:scale(1);} }
  .typing-dot { animation: typing 1.2s infinite ease-in-out both; display:inline-block; width:6px; height:6px; background:#94a3b8; border-radius:50%; margin:0 1px; }
  @keyframes typing { 0%,80%,100%{ transform: scale(0);} 40%{ transform: scale(1);} }
  .shimmer { background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0) 100%); background-size: 200% 100%; animation: shimmer 1.6s infinite; }
  @keyframes shimmer { 0% { background-position: -150% 0 } 100% { background-position: 150% 0 } }
  .phone-frame { width: 360px; height: 720px; border-radius:40px; border: 10px solid #0f1724; overflow:hidden; background:#efeae2; }
  .badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; background:#F8C883; color:#1f2937; font-weight:600; }
  .dialog { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: rgba(2,6,23,0.5); z-index:50; }
  .mini-map { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 10px 10px; }
</style>
</head>
<body class="min-h-screen">

<!-- Config: edit these for live integrations -->
<script>
  const GOOGLE_SCRIPT_URL = ""; // optional: Google Apps Script POST URL to capture feedback
  const WHATSAPP_LINK = "https://wa.me/254XXXXXXXX"; // booking link
  const CALENDLY_URL = ""; // optional
</script>

<!-- HEADER -->
<header class="flex items-center justify-between p-4 bg-white border-b shadow-sm sticky top-0 z-40">
  <div class="flex items-center gap-3">
    <div class="kt-icon">KN</div>
    <div>
      <div class="font-semibold">Kwa Ntau</div>
      <div class="text-xs text-slate-500">Hardware ‚Ä¢ MaliMali Automation</div>
    </div>
  </div>

  <div class="flex items-center gap-3">
    <button id="startWalk" class="px-3 py-1 rounded bg-yellow-400 text-sm">Start Walkthrough</button>
    <button id="onboardBtn" class="px-3 py-1 rounded bg-slate-100 text-sm">Onboard</button>
    <button id="themeToggle" class="px-3 py-1 rounded bg-slate-100 text-sm">Toggle Phone</button>
    <a id="bookBtn" href="#" class="px-3 py-1 rounded bg-emerald-600 text-white text-sm">Book a Call</a>
  </div>
</header>

<!-- MAIN LAYOUT -->
<main class="max-w-7xl mx-auto grid lg:grid-cols-3 gap-6 p-6">

  <!-- LEFT: Chat + Products + Feedback -->
  <section class="col-span-1 space-y-4">
    <!-- Phone Preview: Toggle to show/hide -->
    <div id="phoneWrap" class="bg-white p-4 rounded-2xl shadow-soft">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold">Mobile Preview</div>
        <div class="text-xs text-slate-400">WhatsApp-style demo</div>
      </div>

      <div class="flex justify-center">
        <div class="phone-frame" id="phoneFrame">
          <!-- top header -->
          <div class="bg-[#075E54] text-white p-3 flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-md flex items-center justify-center">ü§ñ</div>
            <div>
              <div class="font-semibold text-sm">Kwa Ntau Bot</div>
              <div class="text-[11px] opacity-80">Replies instantly</div>
            </div>
          </div>

          <div id="mobileChat" class="p-3 overflow-y-auto h-[520px]">
            <!-- messages -->
          </div>

          <div class="p-3 bg-[#f0f2f5] flex items-center gap-2">
            <input id="mobileInput" class="flex-1 px-3 py-2 rounded-full" placeholder="Type a message..." />
            <button id="mobileSend" class="bg-[#075E54] px-3 py-2 rounded-full text-white">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Products grid -->
    <div class="bg-white p-4 rounded-2xl shadow-soft">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="font-semibold">Product Catalog ‚Äî Hardware & MaliMali</div>
          <div class="text-xs text-slate-500">Click to view product details</div>
        </div>
        <div class="text-xs text-slate-400">Cart: <span id="cartCount">0</span></div>
      </div>

      <div id="productGrid" class="grid grid-cols-2 gap-2">
        <!-- products -->
      </div>

      <div class="mt-3 flex justify-between items-center">
        <div class="text-xs text-slate-500">Demo checkout uses simulated M-Pesa</div>
        <div class="flex gap-2">
          <button id="viewCart" class="px-3 py-1 rounded bg-yellow-400">View Cart</button>
          <button id="clearCart" class="px-3 py-1 rounded bg-slate-100">Clear</button>
        </div>
      </div>
    </div>

    <!-- Feedback + Votes -->
    <div class="bg-white p-4 rounded-2xl shadow-soft">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Feedback & Feature Voting</div>
        <div class="text-xs text-slate-400">Help us prioritize</div>
      </div>

      <div class="mt-3 space-y-2">
        <div class="flex items-center justify-between">
          <div>Auto stock alerts</div>
          <button data-feature="auto" class="voteBtn px-3 py-1 rounded bg-slate-100">Vote</button>
        </div>
        <div class="flex items-center justify-between">
          <div>WhatsApp ordering</div>
          <button data-feature="whatsapp" class="voteBtn px-3 py-1 rounded bg-slate-100">Vote</button>
        </div>
        <div class="flex items-center justify-between">
          <div>Delivery tracking</div>
          <button data-feature="delivery" class="voteBtn px-3 py-1 rounded bg-slate-100">Vote</button>
        </div>
      </div>

      <form id="feedbackForm" class="mt-3 space-y-2">
        <input name="name" placeholder="Your name" class="w-full p-2 border rounded" />
        <input name="shop" placeholder="Shop name" class="w-full p-2 border rounded" />
        <textarea name="comment" placeholder="Comments..." rows="3" class="w-full p-2 border rounded"></textarea>
        <div class="flex gap-2">
          <button type="submit" class="px-3 py-2 rounded bg-emerald-600 text-white">Send Feedback</button>
          <button id="exportFeedback" type="button" class="px-3 py-2 rounded bg-slate-100">Export</button>
        </div>
        <div id="feedbackStatus" class="text-xs text-green-600"></div>
      </form>
    </div>
  </section>

  <!-- CENTER: Dashboard & Automation -->
  <section class="col-span-1 lg:col-span-1 space-y-4">
    <!-- Dashboard -->
    <div class="bg-white p-4 rounded-2xl shadow-soft">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold">Admin Dashboard</div>
          <div class="text-xs text-slate-500">Overview</div>
        </div>
        <div class="flex items-center gap-2">
          <select id="abMode" class="text-sm p-1 border rounded">
            <option value="advanced">Advanced</option>
            <option value="minimal">Minimal</option>
          </select>
        </div>
      </div>

      <div id="dashboardArea" class="mt-3 grid grid-cols-2 gap-3">
        <div class="p-3 rounded-lg bg-slate-50">
          <div class="text-xs text-slate-500">Today's Sales</div>
          <div class="text-2xl font-bold">KES <span id="todaySales">14,500</span></div>
        </div>
        <div class="p-3 rounded-lg bg-slate-50">
          <div class="text-xs text-slate-500">Open Orders</div>
          <div class="text-2xl font-bold"><span id="openOrders">3</span></div>
        </div>
        <div id="topSellerCard" class="p-3 rounded-lg bg-slate-50 col-span-2">
          <div class="text-xs text-slate-500">Top Selling Items</div>
          <div id="topSellers" class="mt-1 flex gap-3"></div>
        </div>
        <div id="lowStockCard" class="p-3 rounded-lg bg-slate-50 col-span-2">
          <div class="text-xs text-slate-500">Low Stock Alerts</div>
          <div id="lowStockList" class="mt-2 space-y-1"></div>
        </div>
      </div>

      <div class="mt-4 h-40">
        <canvas id="salesChart"></canvas>
      </div>
    </div>

    <!-- Automation diagram -->
    <div class="bg-white p-4 rounded-2xl shadow-soft">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Automation Flow</div>
        <div class="text-xs text-slate-400">WhatsApp ‚Üí GPT ‚Üí n8n ‚Üí Inventory ‚Üí Delivery</div>
      </div>
      <div class="mt-3">
        <svg width="100%" height="120" viewBox="0 0 1000 120">
          <g>
            <rect id="node1" x="20" y="20" width="140" height="80" rx="8" fill="#fff" stroke="#e6e8eb"></rect>
            <text x="90" y="55" text-anchor="middle" font-size="12" fill="#333">WhatsApp</text>
            <rect id="node2" x="190" y="20" width="140" height="80" rx="8" fill="#fff" stroke="#e6e8eb"></rect>
            <text x="260" y="55" text-anchor="middle" font-size="12" fill="#333">GPT Intent</text>
            <rect id="node3" x="360" y="20" width="140" height="80" rx="8" fill="#fff" stroke="#e6e8eb"></rect>
            <text x="430" y="55" text-anchor="middle" font-size="12" fill="#333">n8n / Make</text>
            <rect id="node4" x="530" y="20" width="140" height="80" rx="8" fill="#fff" stroke="#e6e8eb"></rect>
            <text x="600" y="55" text-anchor="middle" font-size="12" fill="#333">Inventory</text>
            <rect id="node5" x="700" y="20" width="140" height="80" rx="8" fill="#fff" stroke="#e6e8eb"></rect>
            <text x="770" y="55" text-anchor="middle" font-size="12" fill="#333">Delivery</text>

            <!-- arrows -->
            <path d="M160 60 L190 60" stroke="#cbd5e1" stroke-width="2" />
            <path d="M330 60 L360 60" stroke="#cbd5e1" stroke-width="2" />
            <path d="M500 60 L530 60" stroke="#cbd5e1" stroke-width="2" />
            <path d="M670 60 L700 60" stroke="#cbd5e1" stroke-width="2" />
          </g>
        </svg>
        <div class="text-xs text-slate-500 mt-2">Hover nodes to see details (demo)</div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Orders / Cart / Profiles -->
  <aside class="col-span-1 space-y-4">
    <div class="bg-white p-4 rounded-2xl shadow-soft">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Cart & Checkout</div>
        <div class="text-xs text-slate-400">Simulated payments</div>
      </div>

      <div id="cartView" class="mt-3 space-y-2 text-sm text-slate-600">
        <div>No items in cart</div>
      </div>

      <div class="mt-4 flex gap-2">
        <button id="checkoutBtn" class="px-3 py-2 rounded bg-[#075E54] text-white">Checkout (M-Pesa)</button>
        <button id="simulateMpesa" class="px-3 py-2 rounded bg-slate-100">Simulate Pay</button>
      </div>
    </div>

    <div class="bg-white p-4 rounded-2xl shadow-soft">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Recent Orders</div>
        <div class="text-xs text-slate-400">Interactive</div>
      </div>

      <div id="ordersList" class="mt-3 space-y-2">
        <!-- orders -->
      </div>
    </div>

    <div class="bg-white p-4 rounded-2xl shadow-soft">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Customers</div>
        <div class="text-xs text-slate-400">Profiles</div>
      </div>

      <div id="customersList" class="mt-3 space-y-2">
        <!-- customer profiles -->
      </div>
    </div>
  </aside>

</main>

<!-- Walkthrough modal -->
<div id="walkModal" class="hidden dialog">
  <div class="bg-white rounded-xl p-6 max-w-xl w-full">
    <div class="flex justify-between items-center">
      <div class="font-bold">Guided Walkthrough</div>
      <button id="closeWalk" class="text-slate-500">‚úï</button>
    </div>
    <div id="walkContent" class="mt-4">
      <!-- steps injected -->
    </div>
    <div class="mt-4 flex justify-between">
      <button id="prevStep" class="px-3 py-1 rounded bg-slate-100">Previous</button>
      <div class="flex gap-2">
        <button id="nextStep" class="px-3 py-1 rounded bg-emerald-600 text-white">Next</button>
        <button id="finishWalk" class="px-3 py-1 rounded bg-slate-100 hidden">Finish</button>
      </div>
    </div>
  </div>
</div>

<!-- Onboarding modal -->
<div id="onboardModal" class="hidden dialog">
  <div class="bg-white rounded-xl p-6 max-w-lg w-full">
    <div class="flex justify-between items-center">
      <div class="font-bold">Onboarding ‚Äî Quick Setup</div>
      <button id="closeOnboard" class="text-slate-500">‚úï</button>
    </div>
    <form id="onboardForm" class="mt-4 space-y-3">
      <input name="storeName" placeholder="Store name" class="w-full p-2 border rounded" required />
      <select name="storeType" class="w-full p-2 border rounded">
        <option>Hardware / General MaliMali</option>
        <option>Electronics</option>
        <option>Boutique</option>
      </select>
      <div class="flex gap-2">
        <button type="submit" class="px-3 py-2 bg-emerald-600 text-white rounded">Create Demo Store</button>
        <button type="button" id="onboardSkip" class="px-3 py-2 bg-slate-100 rounded">Skip</button>
      </div>
    </form>
  </div>
</div>

<!-- Delivery modal -->
<div id="deliveryModal" class="hidden dialog">
  <div class="bg-white rounded-xl p-6 max-w-md w-full">
    <div class="flex justify-between items-center">
      <div class="font-bold">Delivery Simulation</div>
      <button id="closeDelivery" class="text-slate-500">‚úï</button>
    </div>
    <div class="mt-3">
      <div class="text-sm text-slate-500">Assign a driver to the order and watch tracking updates.</div>
      <div class="mt-3">
        <select id="driverSelect" class="w-full p-2 border rounded">
          <option value="Juma">Juma ‚Äî 2.1 km</option>
          <option value="Asha">Asha ‚Äî 3.4 km</option>
          <option value="Kibwezi">Kibwezi ‚Äî 1.8 km</option>
        </select>
      </div>
      <div class="mt-3 flex justify-end">
        <button id="assignDriver" class="px-3 py-2 bg-emerald-600 text-white rounded">Assign Driver</button>
      </div>
      <div id="deliveryStatus" class="mt-3 text-sm text-slate-600"></div>
    </div>
  </div>
</div>

<!-- small inline scripts -->
<script>
/* -------------------------
  Demo Data (Kenya hardware)
----------------------------*/
const sampleProducts = [
  { id: 'cement50', name: 'Cement 50kg', price: 650, stock: 18, reorder: 10, supplier: 'Industrial Area' },
  { id: 'roofsheet', name: 'Roofing Iron Sheet', price: 3200, stock: 6, reorder: 4, supplier: 'Gikomba' },
  { id: 'boxnails', name: 'Box of Nails (kg)', price: 120, stock: 34, reorder: 10, supplier: 'Kariobangi' },
  { id: 'basin', name: 'Washing Basin', price: 900, stock: 4, reorder: 5, supplier: 'Local market' },
  { id: 'panga', name: 'Panga (Machete)', price: 350, stock: 12, reorder: 5, supplier: 'Local market' },
  { id: 'wheelbarrow', name: 'Wheelbarrow', price: 7200, stock: 2, reorder: 1, supplier: 'Industrial supplier' }
];

let products = JSON.parse(localStorage.getItem('kt_products')) || sampleProducts.map(p => ({...p}));
let orders = JSON.parse(localStorage.getItem('kt_orders')) || [
  { id: 'ord-1', customer: 'Asha ‚Ä¢ MaliMali', total: 3200, items: ['Roofing Iron Sheet'], status: 'pending', created: new Date().toISOString() },
  { id: 'ord-2', customer: 'Juma ‚Ä¢ Shop', total: 770, items: ['Cement 50kg', 'Box of Nails (kg)'], status: 'pending', created: new Date().toISOString() },
  { id: 'ord-3', customer: 'Mary ‚Ä¢ Contractor', total: 1200, items: ['Washing Basin'], status: 'delivered', created: new Date().toISOString() }
];
let customers = JSON.parse(localStorage.getItem('kt_customers')) || [
  { id: 'c-1', name: 'Asha', phone: '+254700111222', ltv: 14500, notes: 'Bulk cement buyer' },
  { id: 'c-2', name: 'Juma', phone: '+254700333444', ltv: 7200, notes: 'Prefers credit' },
  { id: 'c-3', name: 'Mary', phone: '+254700555666', ltv: 1200, notes: '' }
];

let cart = JSON.parse(localStorage.getItem('kt_cart')) || [];

/* -------------------------
  DOM helpers & renders
----------------------------*/
function $q(sel){ return document.querySelector(sel); }
function $qa(sel){ return Array.from(document.querySelectorAll(sel)); }

function renderProducts(){
  const grid = $q('#productGrid'); grid.innerHTML = '';
  products.forEach(p => {
    const div = document.createElement('div');
    div.className = 'p-3 rounded-lg bg-white border cursor-pointer';
    div.innerHTML = `<div class="font-medium">${p.name}</div>
      <div class="text-xs text-slate-500">KES ${p.price.toLocaleString()}</div>
      <div class="text-xs mt-2 ${p.stock < p.reorder ? 'text-red-600 font-semibold' : 'text-slate-500'}">Stock: ${p.stock}</div>`;
    div.onclick = ()=> openProductModal(p.id);
    grid.appendChild(div);
  });
  updateCartCount();
}

function renderTopSellers(){
  // mock: top sellers by random or static mapping
  const target = $q('#topSellers'); target.innerHTML = '';
  const top = products.slice().sort((a,b)=>b.stock - a.stock).slice(0,3);
  top.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'p-2 bg-white rounded-lg border';
    el.innerHTML = `<div class="font-medium">${p.name}</div><div class="text-xs text-slate-500">KES ${p.price}</div>`;
    target.appendChild(el);
  });
}

function renderLowStock(){
  const list = $q('#lowStockList'); list.innerHTML = '';
  products.filter(p=> p.stock <= p.reorder).forEach(p=>{
    const el = document.createElement('div');
    el.className = 'flex items-center justify-between';
    el.innerHTML = `<div class="text-sm">${p.name}</div><div class="text-xs text-red-600">Stock ${p.stock} ‚Ä¢ Reorder ${p.reorder}</div>`;
    list.appendChild(el);
  });
}

function renderOrders(){
  const list = $q('#ordersList'); list.innerHTML = '';
  orders.slice().reverse().forEach(o=>{
    const div = document.createElement('div');
    div.className = 'p-2 rounded-lg bg-slate-50 flex items-start justify-between';
    div.innerHTML = `<div>
        <div class="font-medium">${o.customer}</div>
        <div class="text-xs text-slate-500">${o.items.join(', ')}</div>
        <div class="text-xs text-slate-400 mt-1">${new Date(o.created).toLocaleString()}</div>
      </div>
      <div class="text-right">
        <div class="font-semibold">KES ${o.total}</div>
        <div class="text-xs mt-1">${o.status}</div>
        <div class="mt-2 flex gap-2">
          ${o.status !== 'delivered' ? `<button class="markBtn px-2 py-1 bg-emerald-600 text-white rounded text-xs" data-id="${o.id}">Mark delivered</button>` : ''}
          <button class="viewBtn px-2 py-1 bg-slate-100 rounded text-xs" data-id="${o.id}">View</button>
          <button class="assignBtn px-2 py-1 bg-yellow-400 rounded text-xs" data-id="${o.id}">Assign</button>
        </div>
      </div>`;
    list.appendChild(div);
  });
  $qa('.markBtn').forEach(b=> b.onclick = e=> markDelivered(e.target.dataset.id));
  $qa('.assignBtn').forEach(b=> b.onclick = e=> openDeliveryModal(e.target.dataset.id));
}

function renderCustomers(){
  const list = $q('#customersList'); list.innerHTML = '';
  customers.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'p-2 rounded-lg bg-slate-50 flex items-center justify-between';
    div.innerHTML = `<div><div class="font-medium">${c.name}</div><div class="text-xs text-slate-500">${c.phone}</div></div>
      <div class="text-right"><div class="text-xs">LTV KES ${c.ltv}</div><button class="px-2 py-1 mt-2 text-xs bg-slate-100 rounded viewCust" data-id="${c.id}">View</button></div>`;
    list.appendChild(div);
  });
  $qa('.viewCust').forEach(b=> b.onclick = e=> viewCustomer(e.target.dataset.id));
}

function updateCartCount(){
  $q('#cartCount').textContent = cart.reduce((s,i)=>s+i.qty,0);
  renderCartView();
}

/* -------------------------
  Product modal / add to cart
----------------------------*/
function openProductModal(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  // simple modal using prompt for demo
  const qty = parseInt(prompt(`Add ${p.name} to cart. Available: ${p.stock}\nQuantity:`,'1'));
  if(!qty || qty <= 0) return;
  if(qty > p.stock){ alert('Not enough stock'); return; }
  addToCart(id, qty);
}

function addToCart(id, qty=1){
  const p = products.find(x=>x.id===id);
  const exist = cart.find(c=> c.id===id);
  if(exist) exist.qty += qty;
  else cart.push({ id:p.id, name:p.name, price:p.price, qty });
  saveState();
  updateCartCount();
  appendMobileMessage(`${p.name} added to cart ‚úîÔ∏è`, 'bot');
}

/* -------------------------
  Cart & Checkout
----------------------------*/
function renderCartView(){
  const view = $q('#cartView'); view.innerHTML = '';
  if(cart.length === 0){ view.innerHTML = '<div>No items in cart</div>'; return; }
  let total = 0;
  cart.forEach(it=>{
    total += it.price * it.qty;
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between';
    row.innerHTML = `<div>${it.name} <span class="text-xs text-slate-500">x${it.qty}</span></div><div>KES ${ (it.price*it.qty).toLocaleString() }</div>`;
    view.appendChild(row);
  });
  const tot = document.createElement('div'); tot.className = 'mt-3 flex items-center justify-between font-bold';
  tot.innerHTML = `<div>Total</div><div>KES ${total.toLocaleString()}</div>`;
  view.appendChild(tot);
}

function checkout(){
  if(cart.length === 0){ alert('Cart empty'); return; }
  const total = cart.reduce((s,i)=> s + i.price*i.qty, 0);
  // create mock order
  const id = 'ord-' + Math.random().toString(36).slice(2,6);
  const newOrder = { id, customer: 'Demo Customer', total, items: cart.map(i=>i.name), status:'pending', created: new Date().toISOString() };
  orders.push(newOrder);
  // reduce stock
  cart.forEach(it => {
    const prod = products.find(p => p.id === it.id);
    if(prod) prod.stock = Math.max(0, prod.stock - it.qty);
  });
  cart = [];
  saveState();
  renderCartView(); renderOrders(); renderLowStock(); renderProducts(); renderTopSellers(); updateCounts();
  appendMobileMessage(`Payment request (M-Pesa) for KES ${total} sent. Order ${id} created.`, 'bot');
  // simulate mpesa prompt
  setTimeout(()=> simulateMpesa(total, newOrder.id), 700);
}

function simulateMpesa(amount, orderId){
  const ok = confirm(`Simulate M-Pesa payment of KES ${amount} for order ${orderId}? Click OK to confirm.`);
  if(ok){
    orders = orders.map(o => o.id === orderId ? {...o, status:'delivered'} : o);
    saveState();
    renderOrders(); appendMobileMessage('‚úÖ Payment received. Order marked delivered.', 'bot');
  } else {
    appendMobileMessage('Payment cancelled (demo).', 'bot');
  }
}

/* -------------------------
  Order & delivery actions
----------------------------*/
function markDelivered(id){
  orders = orders.map(o => o.id === id ? {...o, status:'delivered'} : o );
  saveState();
  renderOrders();
}

function openDeliveryModal(orderId){
  $q('#deliveryModal').classList.remove('hidden');
  $q('#assignDriver').dataset.order = orderId;
}

$q('#assignDriver').onclick = function(){
  const orderId = this.dataset.order;
  const driver = $q('#driverSelect').value;
  $q('#deliveryStatus').textContent = `Driver ${driver} assigned. ETA 12 mins...`;
  setTimeout(()=>{
    $q('#deliveryStatus').textContent = `Driver ${driver} en route ‚Äî arriving in 8 mins`;
  }, 2500);
  setTimeout(()=>{
    orders = orders.map(o => o.id === orderId ? {...o, status:'delivered'} : o );
    saveState();
    renderOrders();
    $q('#deliveryStatus').textContent = `Delivered by ${driver}.`;
  }, 7000);
};

/* -------------------------
  Chat simulation (mobile)
----------------------------*/
function appendMobileMessage(text, who='bot'){
  const area = $q('#mobileChat');
  const div = document.createElement('div');
  div.style.maxWidth = '80%'; div.className = `p-2 rounded-lg ${who==='bot' ? 'bg-white text-slate-800' : 'bg-emerald-100 text-slate-800 ml-auto'}`;
  div.textContent = text;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

function processMobileInput(txt){
  appendMobileMessage(txt, 'user');
  // Show typing
  const area = $q('#mobileChat');
  const tdiv = document.createElement('div'); tdiv.className='p-2 rounded-lg bg-white text-slate-800';
  tdiv.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
  area.appendChild(tdiv);
  area.scrollTop = area.scrollHeight;
  setTimeout(()=>{
    tdiv.remove();
    const lower = txt.toLowerCase();
    if(lower.includes('stock') || lower.includes('do you have')) {
      const found = products.find(p => lower.includes(p.name.split(' ')[0].toLowerCase()) || p.name.toLowerCase().includes(lower.replace('do you have ','').trim()));
      if(found) appendMobileMessage(`Yes ‚Äî ${found.name} ‚Ä¢ Price: KES ${found.price} ‚Ä¢ Stock: ${found.stock}`);
      else appendMobileMessage('I can check stock and reserve items. What product are you looking for?');
    } else if(lower.includes('price')) {
      appendMobileMessage('Tell me which product (e.g., "price of cement") and I will respond.');
    } else if(lower.includes('buy') || lower.includes('order') || lower.includes('add')) {
      // quick add if includes product name
      const found = products.find(p => lower.includes(p.name.split(' ')[0].toLowerCase()));
      if(found){ addToCart(found.id, 1); appendMobileMessage(`${found.name} added to cart.`); }
      else appendMobileMessage('Which item should I add to your cart? Try "add cement"');
    } else if(lower.includes('track')) {
      appendMobileMessage('Track: your order is with rider Juma, arriving in 12 mins.');
    } else {
      appendMobileMessage("Demo bot: Try 'stock', 'price', 'add cement', 'buy roofsheet', or 'track order'.");
    }
  }, 800);
}

/* -------------------------
  Walkthrough (story mode)
----------------------------*/
const walkthroughSteps = [
  { id:1, title:'Welcome', text:'Imagine you run a small hardware shop. A customer sends a WhatsApp message asking for cement. Watch the flow.' },
  { id:2, title:'Customer Message', text:'Customer: "Do you have cement?" ‚Äî the bot checks inventory and replies instantly.' },
  { id:3, title:'Upsell', text:'The bot suggests nails and a wheelbarrow to increase order value.' },
  { id:4, title:'Checkout', text:'Customer accepts. The bot sends a simulated M-Pesa prompt and updates the dashboard.' },
  { id:5, title:'Delivery', text:'A driver is assigned and the delivery is tracked. The order is marked delivered.' },
  { id:6, title:'Result', text:'Dashboard updates: sales increased and low-stock alerts appear for items that need reordering.' }
];

let walkIndex = 0;
function startWalk(){
  walkIndex = 0; showWalkStep();
  $q('#walkModal').classList.remove('hidden');
}
function showWalkStep(){
  const s = walkthroughSteps[walkIndex];
  $q('#walkContent').innerHTML = `<div class="font-semibold">${s.title}</div><div class="text-sm text-slate-600 mt-2">${s.text}</div>`;
  $q('#prevStep').disabled = walkIndex === 0;
  if(walkIndex === walkthroughSteps.length -1){ $q('#nextStep').classList.add('hidden'); $q('#finishWalk').classList.remove('hidden'); } else { $q('#nextStep').classList.remove('hidden'); $q('#finishWalk').classList.add('hidden'); }
}
$q('#startWalk').onclick = startWalk;
$q('#closeWalk').onclick = ()=> $q('#walkModal').classList.add('hidden');
$q('#nextStep').onclick = ()=> { walkIndex = Math.min(walkIndex+1, walkthroughSteps.length-1); showWalkStep(); triggerWalkActions(walkIndex); };
$q('#prevStep').onclick = ()=> { walkIndex = Math.max(walkIndex-1,0); showWalkStep(); };
$q('#finishWalk').onclick = ()=> { $q('#walkModal').classList.add('hidden'); };

/* Play demo actions at certain steps */
function triggerWalkActions(index){
  if(index === 1){
    // simulate customer message and bot reply
    processMobileInput('Do you have cement?');
  }
  if(index === 2){
    // upsell simulation
    setTimeout(()=> appendMobileMessage('üí° Suggestion: White nails go well with cement. Add to cart?'), 800);
  }
  if(index === 3){
    setTimeout(()=> addToCart('cement50',1), 1200);
    setTimeout(()=> checkout(), 1800);
  }
  if(index === 4){
    // assign driver to latest order
    const last = orders[orders.length-1];
    if(last) openDeliveryModal(last.id);
  }
}

/* -------------------------
  Votes & Feedback (local or Google Script)
----------------------------*/
$qa('.voteBtn').forEach(btn=>{
  btn.onclick = () => { const k = btn.dataset.feature; voteFeature(k, btn); };
});
function voteFeature(name, btn){
  const votes = JSON.parse(localStorage.getItem('kt_votes')||'{}');
  votes[name] = (votes[name]||0) + 1;
  localStorage.setItem('kt_votes', JSON.stringify(votes));
  btn.textContent = 'Voted ‚úì'; btn.disabled = true;
}

$q('#feedbackForm').onsubmit = async (e) => {
  e.preventDefault();
  const form = e.target;
  const data = { name: form.name.value || 'Anonymous', shop: form.shop.value || '-', comment: form.comment.value || '' };
  if(GOOGLE_SCRIPT_URL){
    try{
      const fd = new FormData(); fd.append('name', data.name); fd.append('shop', data.shop); fd.append('comment', data.comment);
      await fetch(GOOGLE_SCRIPT_URL, { method:'POST', body: fd });
      $q('#feedbackStatus').textContent = 'Thanks ‚Äî saved to Google Sheets.';
    }catch(err){
      saveFeedbackLocal(data); $q('#feedbackStatus').textContent = 'Saved locally (error posting).';
    }
  } else {
    saveFeedbackLocal(data); $q('#feedbackStatus').textContent = 'Saved locally (no backend).';
  }
  form.reset();
  setTimeout(()=> $q('#feedbackStatus').textContent = '', 3000);
};

function saveFeedbackLocal(data){
  const arr = JSON.parse(localStorage.getItem('kt_feedback')||'[]');
  arr.push({...data, ts: new Date().toISOString()});
  localStorage.setItem('kt_feedback', JSON.stringify(arr));
}
$q('#exportFeedback').onclick = ()=>{
  const fb = JSON.parse(localStorage.getItem('kt_feedback')||'[]');
  const votes = JSON.parse(localStorage.getItem('kt_votes')||'{}');
  const out = { feedback: fb, votes };
  const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'kt_feedback.json'; a.click();
};

/* -------------------------
  Onboarding
----------------------------*/
$q('#onboardBtn').onclick = ()=> { $q('#onboardModal').classList.remove('hidden'); };
$q('#closeOnboard').onclick = ()=> $q('#onboardModal').classList.add('hidden');
$q('#onboardSkip').onclick = ()=> { $q('#onboardModal').classList.add('hidden'); };

$q('#onboardForm').onsubmit = e => {
  e.preventDefault();
  const form = e.target;
  const storeName = form.storeName.value;
  // simulate pre-populating data and closing
  products = sampleProducts.map(p => ({...p}));
  orders = [];
  customers = [];
  saveState();
  renderAll();
  $q('#onboardModal').classList.add('hidden');
  alert(`Demo store "${storeName}" created. You can now run the walkthrough.`);
};

/* -------------------------
  Helpers: save state and counts
----------------------------*/
function saveState(){
  localStorage.setItem('kt_products', JSON.stringify(products));
  localStorage.setItem('kt_orders', JSON.stringify(orders));
  localStorage.setItem('kt_customers', JSON.stringify(customers));
  localStorage.setItem('kt_cart', JSON.stringify(cart));
}

function updateCounts(){
  $q('#todaySales').textContent = '14,500'; // static demo
  $q('#openOrders').textContent = orders.filter(o=> o.status !== 'delivered').length;
}

/* -------------------------
  Chart init
----------------------------*/
function initChart(){
  const ctx = $q('#salesChart');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
      datasets:[{ label:'KES Sales', data:[12000,9000,15000,11000,14500,17000,13500], fill:true, tension:0.3, backgroundColor:'rgba(242,143,34,0.12)', borderColor:'rgba(242,143,34,0.95)' }]
    },
    options:{ plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback: v => 'KES '+v } } } }
  });
}

/* -------------------------
  Generic init & bindings
----------------------------*/
$q('#mobileSend').onclick = ()=> {
  const v = $q('#mobileInput').value.trim(); if(!v) return; processMobileInput(v); $q('#mobileInput').value = '';
};
$q('#viewCart').onclick = ()=> { $q('#panel')?.scrollIntoView?.({behavior:'smooth'}); $q('#panel')?.focus?.(); };
$q('#clearCart').onclick = ()=> { cart = []; saveState(); renderCartView(); updateCartCount(); };
$q('#checkoutBtn').onclick = ()=> checkout();
$q('#simulateMpesa').onclick = ()=> { if(confirm('Simulate M-Pesa success?')) { orders = orders.map(o=> ({...o, status:'delivered'})); saveState(); renderOrders(); appendMobileMessage('‚úÖ All demo orders marked delivered', 'bot'); } };

$q('#closeDelivery').onclick = ()=> $q('#deliveryModal').classList.add('hidden');
$q('#closeWalk').onclick = ()=> $q('#walkModal').classList.add('hidden');

$q('#bookBtn').onclick = (e)=> { e.preventDefault(); if(CALENDLY_URL) window.open(CALENDLY_URL, '_blank'); else window.open(WHATSAPP_LINK, '_blank'); };

$q('#themeToggle').onclick = ()=> {
  const pf = $q('#phoneWrap'); pf.classList.toggle('hidden');
};

/* -------------------------
  Product quick add via anchors
----------------------------*/
function quickAddDemo(){
  addToCart('cement50',1);
  addToCart('boxnails',2);
}

/* -------------------------
  Rendering all pieces
----------------------------*/
function renderAll(){
  renderProducts(); renderTopSellers(); renderLowStock(); renderOrders(); renderCustomers(); renderCartView(); initChart(); updateCounts();
}
renderAll();

/* persist before unload */
window.addEventListener('beforeunload', saveState);

</script>

</body>
</html>
